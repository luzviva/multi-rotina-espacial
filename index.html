<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rotina Espacial v2</title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background: #000010;
            color: white;
            overflow-y: scroll;
        }

        #app-container {
            background-image:
                radial-gradient(white, rgba(255, 255, 255, .2) 2px, transparent 40px),
                radial-gradient(white, rgba(255, 255, 255, .15) 1px, transparent 30px),
                radial-gradient(white, rgba(255, 255, 255, .1) 2px, transparent 40px),
                radial-gradient(rgba(255, 255, 255, .4), rgba(255, 255, 255, .1) 2px, transparent 30px);
            background-size: 550px 550px, 350px 350px, 250px 250px, 150px 150px;
            background-position: 0 0, 40px 60px, 130px 270px, 70px 100px;
            animation: stars-move 60s linear infinite;
        }

        @keyframes stars-move {
            from {
                background-position: 0 0, 40px 60px, 130px 270px, 70px 100px;
            }
            to {
                background-position: -550px -550px, -310px -290px, -120px -270px, -80px -50px;
            }
        }
        
        .animate-title-glow {
            animation: title-glow 2s ease-in-out infinite alternate;
        }

        @keyframes title-glow {
            from {
                text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #fefcbf, 0 0 20px #fefcbf;
            }
            to {
                text-shadow: 0 0 10px #fff, 0 0 20px #fefcbf, 0 0 30px #fefcbf, 0 0 40px #fefcbf;
            }
        }

        .animate-star-pulse {
            animation: star-pulse 1.5s ease-in-out infinite;
        }

        @keyframes star-pulse {
            0%, 100% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.1); filter: brightness(1.5); }
        }

        .form-input-styled {
            @apply w-full bg-slate-800/80 border-2 border-indigo-500/50 rounded-lg p-3 text-white focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition-all;
        }

        .day-selector-btn {
            @apply p-3 rounded-lg bg-indigo-900/60 text-white font-bold transition-all duration-200 border-2 border-transparent hover:bg-indigo-700/80;
        }

        .day-selector-btn.selected {
            @apply bg-purple-600 border-purple-400 shadow-lg shadow-purple-500/30;
        }

        .custom-checkbox {
            @apply w-6 h-6 shrink-0 appearance-none bg-slate-800 border-2 border-indigo-500/50 rounded transition-all duration-200 cursor-pointer;
            @apply checked:bg-purple-600 checked:border-purple-400;
        }

        .custom-checkbox:checked {
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-nunito">

    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex flex-col items-center justify-center z-50 transition-opacity duration-500">
        <div class="text-yellow-300 text-4xl mb-4 font-black animate-title-glow">Rotina Espacial</div>
        <div class="text-cyan-200 text-xl">Carregando dados da galáxia...</div>
        <div class="mt-8 w-16 h-16 border-4 border-dashed rounded-full animate-spin border-cyan-400"></div>
    </div>

    <div id="app-container" class="min-h-screen w-full p-4 md:p-6 lg:p-8 relative opacity-0 transition-opacity duration-500">

        <!-- Child View -->
        <main id="child-view" class="flex-col h-full">
            <header class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-8 space-y-4 lg:space-y-0">
                <div class="space-y-2">
                    <h1 id="welcome-title" class="text-4xl md:text-5xl font-black text-yellow-300 animate-title-glow">Rotina de Hoje</h1>
                    <p id="current-date" class="text-lg text-cyan-200"></p>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="switch-to-store-btn" class="p-4 rounded-full bg-indigo-600 hover:bg-indigo-500 transition-all duration-300 shadow-lg hover:shadow-indigo-500/30 hover:scale-110 active:scale-95">
                        <i data-lucide="shopping-cart" class="w-7 h-7"></i>
                    </button>
                    <div id="coin-counter" class="flex items-center gap-3 bg-black bg-opacity-40 p-3 lg:p-4 rounded-2xl border-2 border-cyan-400 shadow-lg transition-all duration-300 hover:shadow-cyan-400/30">
                        <img src="https://r2.flowith.net/files/o/1749768887371-star_coin_icon_for_children's_space-themed_rewards_system_index_1@1024x1024.png" alt="Estrela" class="w-12 h-12 lg:w-14 lg:h-14 animate-star-pulse">
                        <span id="coin-total" class="text-4xl lg:text-5xl font-black text-yellow-300">0</span>
                    </div>
                </div>
            </header>
            
            <section id="schedule-grid" class="flex-grow space-y-2">
                <!-- New schedule list will be injected here by JavaScript -->
            </section>
            
            <footer class="mt-8 text-center">
                <button id="switch-to-admin" class="p-4 rounded-full bg-purple-600 hover:bg-purple-500 transition-all duration-300 shadow-lg hover:shadow-purple-500/30 hover:scale-110 active:scale-95">
                    <i data-lucide="settings" class="w-8 h-8"></i>
                </button>
            </footer>
        </main>

        <!-- Store View -->
        <section id="store-view" class="hidden flex-col h-full">
            <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 space-y-4 md:space-y-0">
                <h1 class="text-4xl lg:text-5xl font-black text-yellow-300 animate-title-glow">Loja Espacial</h1>
                <button id="back-to-schedule-from-store" class="flex items-center gap-3 p-3 rounded-xl bg-purple-600 hover:bg-purple-500 transition-all shadow-lg hover:shadow-purple-500/30">
                    <span class="font-bold text-lg">Voltar</span>
                    <i data-lucide="arrow-left-circle" class="w-6 h-6"></i>
                </button>
            </header>
            <div class="flex justify-end mb-6">
                 <div id="store-coin-counter" class="flex items-center gap-3 bg-black bg-opacity-40 p-3 rounded-2xl border-2 border-cyan-400 shadow-lg">
                    <span class="font-bold text-lg text-cyan-200">Seu Saldo:</span>
                    <img src="https://r2.flowith.net/files/o/1749768887371-star_coin_icon_for_children's_space-themed_rewards_system_index_1@1024x1024.png" alt="Estrela" class="w-10 h-10 animate-star-pulse">
                    <span id="store-coin-balance" class="text-3xl font-black text-yellow-300">0</span>
                </div>
            </div>
            <div id="store-items-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Store items will be injected here by JS -->
            </div>
        </section>

        <!-- Admin View -->
        <aside id="admin-view" class="hidden flex-col h-full">
            <header class="flex justify-between items-center mb-8">
                <h1 class="text-4xl lg:text-5xl font-black text-cyan-300">Painel dos Pais</h1>
                 <button id="switch-to-child" class="p-4 rounded-full bg-cyan-600 hover:bg-cyan-500 transition-all duration-300 shadow-lg hover:shadow-cyan-500/30 hover:scale-110 active:scale-95">
                    <i data-lucide="home" class="w-8 h-8"></i>
                </button>
            </header>

            <section id="task-management" class="bg-black bg-opacity-50 backdrop-blur-sm p-6 rounded-2xl border border-gray-700 mb-8">
                <h2 id="form-title" class="text-2xl font-bold mb-6 text-yellow-300">Adicionar Nova Tarefa</h2>
                <form id="task-form" class="space-y-6">
                    <input type="hidden" id="task-id">
                    <div>
                        <label for="task-description" class="block mb-2 font-bold text-cyan-200">Descrição</label>
                        <input type="text" id="task-description" placeholder="Ex: Escovar os dentes" class="form-input-styled" required>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="task-time" class="block mb-2 font-bold text-cyan-200">Horário Início</label>
                            <input type="time" id="task-time" class="form-input-styled" required>
                        </div>
                        <div>
                            <label for="endTime" class="block mb-2 font-bold text-cyan-200">Horário Fim</label>
                            <input type="time" id="endTime" class="form-input-styled">
                        </div>
                    </div>
                    <div>
                        <label class="block mb-2 font-bold text-cyan-200">Dias da Semana</label>
                        <div id="task-days" class="grid grid-cols-4 sm:grid-cols-7 gap-2">
                             <!-- Day buttons will be injected here -->
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                         <div class="flex items-center gap-3">
                            <input type="checkbox" id="task-reward" class="custom-checkbox">
                            <label for="task-reward" class="font-bold text-cyan-200">Dá recompensa?</label>
                        </div>
                         <div class="flex items-center gap-3">
                            <input type="checkbox" id="enableNotifications" class="custom-checkbox">
                            <label for="enableNotifications" class="font-bold text-cyan-200">Habilitar Notificações</label>
                        </div>
                    </div>
                    <div class="pt-4 flex flex-col sm:flex-row gap-4">
                        <button type="submit" id="form-submit-btn" class="w-full flex items-center justify-center p-3 rounded-lg text-lg font-bold btn-primary bg-green-600 hover:bg-green-500">
                            <i data-lucide="plus-circle" class="mr-2"></i> <span>Adicionar Tarefa</span>
                        </button>
                        <button type="button" id="form-cancel-btn" class="w-full flex items-center justify-center p-3 rounded-lg text-lg font-bold btn-secondary bg-red-600 hover:bg-red-500 mt-3 sm:mt-0 hidden">
                             <i data-lucide="x-circle" class="mr-2"></i> Cancelar Edição
                        </button>
                    </div>
                </form>
            </section>
            
            <section id="store-management" class="bg-black bg-opacity-50 backdrop-blur-sm p-6 rounded-2xl border border-gray-700 mt-8">
                <h2 class="text-2xl font-bold mb-6 text-yellow-300">Gerenciar Loja</h2>
                <div class="mb-8 p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                    <h3 class="text-xl font-bold text-cyan-200 mb-3">Gerenciar Saldo</h3>
                    <p class="mb-2 text-sm text-gray-400">Saldo Atual: <span id="current-admin-balance" class="font-bold text-yellow-300">0</span></p>
                    <div class="flex items-end gap-4">
                        <div class="flex-grow">
                            <label for="new-coin-balance" class="block mb-1 text-sm text-cyan-200">Definir novo saldo</label>
                            <input type="number" id="new-coin-balance" placeholder="Ex: 100" class="form-input-styled">
                        </div>
                        <button id="save-coin-balance-btn" class="bg-orange-500 hover:bg-orange-400 text-white font-bold py-3 px-6 rounded-lg transition-transform active:scale-95">Salvar</button>
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-cyan-200 mb-3">Gerenciar Produtos</h3>
                    <div id="admin-product-list" class="space-y-3 mb-6">
                        <!-- Admin product list will be injected here -->
                    </div>
                    <h4 class="text-lg font-bold text-cyan-200 mb-4">Adicionar Novo Produto</h4>
                    <form id="add-product-form" class="space-y-4">
                        <input type="text" id="product-name" placeholder="Nome do Produto" class="form-input-styled" required>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="number" id="product-price" placeholder="Preço (moedas)" class="form-input-styled" required min="0">
                            <input type="url" id="product-image-url" placeholder="URL da Imagem" class="form-input-styled" required>
                        </div>
                        <button type="submit" class="w-full bg-orange-600 hover:bg-orange-500 text-white font-bold py-3 rounded-lg transition-transform active:scale-95">Adicionar Produto</button>
                    </form>
                </div>
            </section>
        </aside>

    </div>

    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- CONSTANTS & STATE ---
            const PARENTAL_SESSION_KEY = 'parentalSessionActive';
            const CORRECT_PIN = "1234"; // Placeholder for actual PIN retrieval
            const WEEK_DAYS = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            
            let state = {
                tasks: [],
                storeItems: [],
                coins: 0,
                currentDate: new Date(),
            };

            // --- MOCK FIREBASE/API FUNCTIONS ---
            // In a real app, these would be async calls to a backend like Firebase.
            const db = {
                fetchTasks: async () => {
                    console.log("Fetching tasks...");
                    return [
                        { id: 'task1', description: 'Arrumar a cama', time: '08:00', endTime: '08:15', days: [1, 2, 3, 4, 5], reward: true, completed: false },
                        { id: 'task2', description: 'Escovar os dentes', time: '08:15', endTime: '08:20', days: [0, 1, 2, 3, 4, 5, 6], reward: false, completed: false },
                        { id: 'task3', description: 'Lanchinho da tarde', time: '17:00', endTime: '17:30', days: [1, 2, 3, 4, 5], reward: false, completed: true },
                        { id: 'task4', description: 'Estudar', time: '17:30', endTime: '18:00', days: [1, 2, 3, 4, 5], reward: true, completed: false },
                        { id: 'task5', description: 'Guardar brinquedos', time: '20:00', endTime: '20:30', days: [0, 1, 2, 3, 4, 5, 6], reward: true, completed: false },
                    ];
                },
                fetchStoreItems: async () => {
                    console.log("Fetching store items...");
                    return [
                        { id: 'item1', name: 'Nave Espacial de Lego', price: 50, imageUrl: 'https://images.unsplash.com/photo-1633483371429-f83a8da7a744?q=80&w=800' },
                        { id: 'item2', name: 'Fantasia de Astronauta', price: 75, imageUrl: 'https://images.unsplash.com/photo-1544199583-055b80998536?q=80&w=800' },
                        { id: 'item3', name: 'Uma hora de videogame', price: 25, imageUrl: 'https://images.unsplash.com/photo-1593305531732-51225a667c45?q=80&w=800' },
                    ];
                },
                fetchCoins: async () => {
                    console.log("Fetching coins...");
                    return 55;
                },
                saveTask: async (task) => console.log('Saving task:', task),
                updateTask: async (taskId, updates) => console.log(`Updating task ${taskId}:`, updates),
                saveStoreItem: async (item) => console.log('Saving store item:', item),
                deleteStoreItem: async (itemId) => console.log(`Deleting store item ${itemId}`),
                updateCoins: async (newTotal) => {
                    console.log(`Updating coins to ${newTotal}`);
                    state.coins = newTotal;
                    updateCoinDisplays();
                }
            };

            // --- UI SELECTORS ---
            const loadingOverlay = document.getElementById('loading-overlay');
            const appContainer = document.getElementById('app-container');
            const childView = document.getElementById('child-view');
            const adminView = document.getElementById('admin-view');
            const storeView = document.getElementById('store-view');
            
            // --- AUTHENTICATION ---
            function isParentalSessionActive() {
                return sessionStorage.getItem(PARENTAL_SESSION_KEY) === 'true';
            }

            async function handleAdminAccess() {
                if (isParentalSessionActive()) {
                    showView('admin');
                    return;
                }
                const enteredPin = prompt("Por favor, insira o PIN dos pais:");
                if (enteredPin === CORRECT_PIN) {
                    sessionStorage.setItem(PARENTAL_SESSION_KEY, 'true');
                    showView('admin');
                } else if (enteredPin) {
                    alert('PIN incorreto. Acesso negado.');
                }
            }

            // --- UI RENDERING & MANAGEMENT ---
            function showView(viewName) {
                childView.classList.add('hidden');
                adminView.classList.add('hidden');
                storeView.classList.add('hidden');
                childView.classList.remove('flex');
                adminView.classList.remove('flex');
                storeView.classList.remove('flex');

                if (viewName === 'child') {
                    childView.classList.remove('hidden');
                    childView.classList.add('flex');
                } else if (viewName === 'admin') {
                    adminView.classList.remove('hidden');
                    adminView.classList.add('flex');
                } else if (viewName === 'store') {
                    storeView.classList.remove('hidden');
                    storeView.classList.add('flex');
                    renderStoreItems();
                }
            }

            function updateDateDisplay() {
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('current-date').textContent = state.currentDate.toLocaleDateString('pt-BR', options);
            }
            
            function updateCoinDisplays() {
                const coinElements = ['coin-total', 'store-coin-balance', 'current-admin-balance'];
                coinElements.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.textContent = state.coins;
                });
            }

            function renderSchedule() {
                const grid = document.getElementById('schedule-grid');
                grid.innerHTML = '';
                const today = state.currentDate.getDay();
                const now = new Date();

                const tasksForToday = state.tasks
                    .filter(task => task.days.includes(today))
                    .sort((a, b) => a.time.localeCompare(b.time));

                if (tasksForToday.length === 0) {
                    grid.innerHTML = `<div class="text-center text-cyan-300 p-8 bg-black bg-opacity-30 rounded-2xl">Nenhuma tarefa para hoje. Hora de explorar a galáxia!</div>`;
                    return;
                }

                tasksForToday.forEach(task => {
                    const [taskHour, taskMinute] = task.time.split(':').map(Number);
                    const [endHour, endMinute] = task.endTime ? task.endTime.split(':').map(Number) : [null, null];

                    let statusClass = 'task-pending';
                    let statusIcon = 'check';
                    let buttonClass = 'bg-green-500 hover:bg-green-400 shadow-green-500/30';
                    let timeMarkerClass = 'text-cyan-300';

                    if (task.completed) {
                        statusClass = 'task-completed opacity-60';
                        statusIcon = 'check-check';
                        buttonClass = 'bg-gray-600';
                    } else if (
                        now.getHours() > taskHour ||
                        (now.getHours() === taskHour && now.getMinutes() >= taskMinute)
                    ) {
                         if (!task.endTime || (now.getHours() < endHour || (now.getHours() === endHour && now.getMinutes() < endMinute))) {
                            statusClass = 'task-active';
                            statusIcon = 'check';
                            buttonClass = 'bg-yellow-500 hover:bg-yellow-400 shadow-yellow-500/30';
                            timeMarkerClass = 'text-yellow-300 animate-pulse';
                        }
                    }

                    const cardHtml = `
                        <div class="flex items-start gap-4 relative task-item" data-task-id="${task.id}">
                            <div class="font-bold text-sm pt-3 w-12 text-right ${timeMarkerClass}">${task.time}</div>
                            <div class="flex-1 flex items-center justify-between p-3 rounded-2xl bg-slate-800/70 border border-cyan-600/50 backdrop-blur-sm transition-all duration-300 task-card ${statusClass}">
                                <div>
                                    <p class="text-xs text-cyan-200">${task.time}${task.endTime ? ' - ' + task.endTime : ''}</p>
                                    <h3 class="text-lg font-bold text-white">${task.description} ${task.reward ? '<span class="text-yellow-400">*</span>' : ''}</h3>
                                </div>
                                <button data-task-id="${task.id}" class="w-10 h-10 rounded-full flex items-center justify-center transition-transform hover:scale-110 active:scale-95 shadow-lg complete-btn ${buttonClass}" ${task.completed ? 'disabled' : ''}>
                                    <i data-lucide="${statusIcon}" class="w-6 h-6"></i>
                                </button>
                            </div>
                        </div>`;
                    grid.innerHTML += cardHtml;
                });
                lucide.createIcons();
            }

            function renderStoreItems() {
                const grid = document.getElementById('store-items-grid');
                grid.innerHTML = '';
                if(state.storeItems.length === 0){
                    grid.innerHTML = `<div class="col-span-full text-center text-cyan-300 p-8 bg-black bg-opacity-30 rounded-2xl">A loja está vazia. Volte mais tarde!</div>`;
                    return;
                }
                state.storeItems.forEach(item => {
                    const canAfford = state.coins >= item.price;
                    const cardHtml = `
                        <div class="bg-slate-800/80 border border-indigo-500/30 rounded-2xl p-4 flex flex-col justify-between hover:border-indigo-400 hover:scale-105 transition-all duration-300 backdrop-blur-sm">
                            <div>
                                <img src="${item.imageUrl}" alt="${item.name}" class="w-full h-48 object-cover rounded-lg mb-4 bg-slate-700">
                                <h3 class="text-xl font-bold text-white mb-4 h-14">${item.name}</h3>
                            </div>
                            <div class="flex justify-between items-center mt-auto pt-4 border-t border-slate-700">
                                <div class="flex items-center gap-2">
                                    <img src="https://r2.flowith.net/files/o/1749768887371-star_coin_icon_for_children's_space-themed_rewards_system_index_1@1024x1024.png" alt="Estrela" class="w-6 h-6">
                                    <span class="text-xl font-bold text-yellow-300">${item.price}</span>
                                </div>
                                <button data-item-id="${item.id}" data-item-price="${item.price}" class="buy-item-btn text-white font-bold py-2 px-4 rounded-lg transition-transform active:scale-95 ${canAfford ? 'bg-orange-500 hover:bg-orange-400' : 'bg-gray-500 cursor-not-allowed'}" ${!canAfford ? 'disabled' : ''}>
                                    Comprar
                                </button>
                            </div>
                        </div>`;
                    grid.innerHTML += cardHtml;
                });
                 lucide.createIcons();
            }

            function renderAdminProductList() {
                const list = document.getElementById('admin-product-list');
                list.innerHTML = '';
                 if(state.storeItems.length === 0){
                    list.innerHTML = `<p class="text-gray-400">Nenhum produto cadastrado.</p>`;
                    return;
                }
                state.storeItems.forEach(item => {
                    const itemHtml = `
                    <div class="flex items-center justify-between bg-slate-900/50 p-3 rounded-lg">
                        <div class="flex items-center gap-4">
                            <img src="${item.imageUrl}" class="w-12 h-12 rounded-md object-cover bg-slate-700">
                            <div>
                                <p class="font-bold text-white">${item.name}</p>
                                <p class="text-sm text-yellow-400">${item.price} moedas</p>
                            </div>
                        </div>
                        <button data-item-id="${item.id}" class="delete-item-btn p-2 rounded-full text-red-400 hover:bg-red-500 hover:text-white transition-colors">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                    `;
                    list.innerHTML += itemHtml;
                });
                lucide.createIcons();
            }

            function setupDaySelectors() {
                const container = document.getElementById('task-days');
                container.innerHTML = WEEK_DAYS.map((day, index) => 
                    `<button type="button" data-day="${index}" class="day-selector-btn">${day}</button>`
                ).join('');
            }
            
            // --- EVENT HANDLERS ---
            function handleTaskComplete(e) {
                const button = e.target.closest('.complete-btn');
                if (!button) return;
                
                const taskId = button.dataset.taskId;
                const task = state.tasks.find(t => t.id === taskId);
                
                if (task && !task.completed) {
                    task.completed = true;
                    if(task.reward){
                        state.coins += 1; // Assuming 1 coin per rewarded task
                        db.updateCoins(state.coins);
                    }
                    db.updateTask(taskId, { completed: true });
                    renderSchedule();
                }
            }

            function handleBuyItem(e) {
                const button = e.target.closest('.buy-item-btn');
                if (!button) return;

                const price = parseInt(button.dataset.itemPrice);
                if (state.coins >= price) {
                    if (confirm(`Comprar este item por ${price} moedas?`)) {
                        db.updateCoins(state.coins - price);
                        alert("Compra realizada com sucesso!");
                        renderStoreItems();
                    }
                } else {
                    alert("Você não tem moedas suficientes!");
                }
            }
            
            function handleTaskFormSubmit(e) {
                e.preventDefault();
                if (!isParentalSessionActive()) {
                    alert('Sessão expirada. Por favor, acesse a área dos pais novamente.');
                    showView('child');
                    return;
                }
                const form = e.target;
                const selectedDays = Array.from(form.querySelectorAll('.day-selector-btn.selected')).map(btn => parseInt(btn.dataset.day));
                
                const newTask = {
                    id: 'task' + Date.now(),
                    description: form.querySelector('#task-description').value,
                    time: form.querySelector('#task-time').value,
                    endTime: form.querySelector('#endTime').value,
                    days: selectedDays,
                    reward: form.querySelector('#task-reward').checked,
                    notifications: form.querySelector('#enableNotifications').checked,
                    completed: false
                };
                
                state.tasks.push(newTask);
                db.saveTask(newTask);
                alert('Tarefa adicionada com sucesso!');
                form.reset();
                document.querySelectorAll('.day-selector-btn.selected').forEach(btn => btn.classList.remove('selected'));
                renderSchedule();
            }

            function handleAddProductFormSubmit(e){
                e.preventDefault();
                if (!isParentalSessionActive()) {
                    alert('Sessão expirada. Por favor, acesse a área dos pais novamente.');
                    showView('child');
                    return;
                }
                 const form = e.target;
                 const newProduct = {
                    id: 'item' + Date.now(),
                    name: form.querySelector('#product-name').value,
                    price: parseInt(form.querySelector('#product-price').value),
                    imageUrl: form.querySelector('#product-image-url').value,
                 };

                 state.storeItems.push(newProduct);
                 db.saveStoreItem(newProduct);
                 alert('Produto adicionado com sucesso!');
                 form.reset();
                 renderAdminProductList();
                 renderStoreItems();
            }
            
            function handleDeleteItem(e){
                const button = e.target.closest('.delete-item-btn');
                if(!button) return;

                if(confirm('Tem certeza que deseja excluir este produto?')){
                    const itemId = button.dataset.itemId;
                    state.storeItems = state.storeItems.filter(item => item.id !== itemId);
                    db.deleteStoreItem(itemId);
                    renderAdminProductList();
                    renderStoreItems();
                }
            }

            function handleSaveCoinBalance(){
                if (!isParentalSessionActive()) {
                    alert('Sessão expirada. Por favor, acesse a área dos pais novamente.');
                    showView('child');
                    return;
                }
                const input = document.getElementById('new-coin-balance');
                const newBalance = parseInt(input.value);
                if(!isNaN(newBalance) && newBalance >= 0){
                    db.updateCoins(newBalance);
                    alert('Saldo de moedas atualizado!');
                    input.value = '';
                } else {
                    alert('Por favor, insira um valor válido.');
                }
            }


            // --- INITIALIZATION ---
            async function init() {
                // Attach main event listeners
                document.getElementById('switch-to-admin').addEventListener('click', handleAdminAccess);
                document.getElementById('switch-to-child').addEventListener('click', () => showView('child'));
                document.getElementById('switch-to-store-btn').addEventListener('click', () => showView('store'));
                document.getElementById('back-to-schedule-from-store').addEventListener('click', () => showView('child'));

                // Child view listeners
                document.getElementById('schedule-grid').addEventListener('click', handleTaskComplete);
                
                // Store view listeners
                document.getElementById('store-items-grid').addEventListener('click', handleBuyItem);

                // Admin view listeners
                document.getElementById('task-form').addEventListener('submit', handleTaskFormSubmit);
                document.getElementById('add-product-form').addEventListener('submit', handleAddProductFormSubmit);
                document.getElementById('save-coin-balance-btn').addEventListener('click', handleSaveCoinBalance);
                document.getElementById('admin-product-list').addEventListener('click', handleDeleteItem);

                document.getElementById('task-days').addEventListener('click', (e) => {
                    if (e.target.classList.contains('day-selector-btn')) {
                        e.target.classList.toggle('selected');
                    }
                });

                // Load data
                [state.tasks, state.storeItems, state.coins] = await Promise.all([
                    db.fetchTasks(),
                    db.fetchStoreItems(),
                    db.fetchCoins()
                ]);

                // Initial render
                updateDateDisplay();
                updateCoinDisplays();
                setupDaySelectors();
                renderSchedule();
                renderAdminProductList();
                showView('child');
                
                // Fade in app
                loadingOverlay.style.opacity = '0';
                setTimeout(() => {
                    loadingOverlay.style.display = 'none';
                    appContainer.style.opacity = '1';
                }, 500);
                 lucide.createIcons();
            }

            init();
        });
    </script>
</body>
</html>
